---
import { Icon } from "astro-icon/components";
import OptimizedImage from "./OptimizedImage.astro";

interface Props {
  name: string;
  nameKey?: string;
  descriptionKey?: string;
  category: string;
  categoryKey?: string;
  technologies: string[];
  urlDemo: string;
  urlGit: string;
  images: string[];
}

const {
  name,
  nameKey,
  urlDemo,
  urlGit,
  images,
  category,
  categoryKey,
  descriptionKey,
  technologies,
} = Astro.props;

const mainImage = images[0];
---

<div
  class="project-card group bg-[#111827]/40 backdrop-blur-md border border-slate-800/60 rounded-2xl p-6 transition-all duration-500 hover:border-shakespeare-500/40 hover:bg-[#111827] hover:shadow-[0_30px_60px_-15px_rgba(0,0,0,0.5)] flex flex-col h-full border-b-2 hover:border-b-shakespeare-500 "
>
  <div class="flex justify-end mb-2">
    <div class="flex gap-4 items-center">
      {
        urlGit && (
          <a
            href={urlGit}
            target="_blank"
            class="text-slate-500 hover:text-white transition-all transform hover:-translate-y-1"
            aria-label="GitHub"
          >
            <Icon name="mdi:github" class="size-6" />
          </a>
        )
      }
      {
        urlDemo && (
          <a
            href={urlDemo}
            target="_blank"
            class="text-slate-500 hover:text-shakespeare-400 transition-all transform hover:-translate-y-1"
            aria-label="Live Demo"
          >
            <Icon name="mdi:external-link" class="size-6" />
          </a>
        )
      }
    </div>
  </div>

  <div class="flex gap-2 items-center mb-2">
    <button
      class="expand-img-btn relative size-28 shrink-0 rounded-2xl overflow-hidden border border-slate-700/50 group-hover:border-shakespeare-500/50 transition-all duration-500 shadow-2xl bg-slate-800"
      data-project-images={images.join(",")}
    >
      <OptimizedImage
        src={mainImage}
        alt={name}
        width={300}
        height={300}
        class="project-thumbnail w-full h-full object-cover grayscale-[0.5] group-hover:grayscale-0 transition-all duration-700"
      />
      <div
        class="absolute inset-0 bg-gradient-to-tr from-shakespeare-900/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
      >
        <Icon
          name="mdi:arrow-expand"
          class="text-white size-8 drop-shadow-lg"
        />
      </div>
    </button>

    <div class="space-y-2">
      <h3
        class="font-bold text-slate-100 text-2xl tracking-tight leading-none"
        data-i18n={nameKey}
      >
        {name}
      </h3>
      <p
        class="text-[13px] text-slate-400 line-clamp-3 leading-relaxed font-normal"
        data-i18n={descriptionKey}
      >
      </p>
    </div>
  </div>

  <div class="mt-auto space-y-5">
    <div class="flex flex-wrap gap-2">
      {
        technologies.map((tech) => (
          <span class="text-[11px] font-bold tracking-wider text-shakespeare-300/80  bg-shakespeare-500/5 px-2.5 py-1 rounded-md border border-shakespeare-500/10">
            {tech}
          </span>
        ))
      }
    </div>


      <div class="flex items-center gap-2">
        <div class="size-1.5 rounded-full bg-shakespeare-500 animate-pulse">
        </div>
        <span
          class="text-[12px] font-bold tracking-wider text-slate-300 uppercase"
          data-i18n={categoryKey}
        >
          {category}
        </span>
 
  </div>
</div>

<dialog
  id="image-modal"
  class="bg-transparent backdrop:backdrop-blur-2xl p-0 w-full h-full max-w-full max-h-full border-none outline-none overflow-hidden group/modal"
>
  <div
    class="relative w-full h-full flex items-center justify-center bg-[#020617]/95"
  >
    <button
      id="prev-img"
      class="absolute left-6 z-[100] text-white/20 hover:text-shakespeare-400 transition-all p-4 hidden sm:block"
    >
      <Icon name="mdi:chevron-left" class="size-16" />
    </button>
    <button
      id="next-img"
      class="absolute right-6 z-[100] text-white/20 hover:text-shakespeare-400 transition-all p-4 hidden sm:block"
    >
      <Icon name="mdi:chevron-right" class="size-16" />
    </button>
    <button
      id="close-modal"
      class="absolute top-8 right-8 z-[100] text-white/20 hover:text-red-400 transition-all"
    >
      <Icon name="mdi:close-circle-outline" class="size-10" />
    </button>

    <div
      class="w-full h-full flex items-center justify-center p-4 md:p-12 cursor-zoom-out"
      id="modal-bg-close"
    >
      <img
        id="modal-img"
        src=""
        class="max-w-full max-h-full object-contain rounded-xl shadow-[0_0_80px_rgba(59,130,246,0.15)] transform transition-all duration-500 select-none"
      />
    </div>
  </div>
</dialog>

<script>
  const initModal = () => {
    const modal = document.getElementById("image-modal") as HTMLDialogElement;
    const modalImg = document.getElementById("modal-img") as HTMLImageElement;
    const nextBtn = document.getElementById("next-img");
    const prevBtn = document.getElementById("prev-img");
    const closeBtn = document.getElementById("close-modal");
    const bgClose = document.getElementById("modal-bg-close");

    let imagesList: string[] = [];
    let currentIndex = 0;

    const updateView = () => {
      if (!modalImg) return;
      modalImg.style.opacity = "0";
      modalImg.style.transform = "scale(0.98)";

      const loader = new Image();
      loader.src = imagesList[currentIndex];
      loader.onload = () => {
        modalImg.src = imagesList[currentIndex];
        modalImg.style.opacity = "1";
        modalImg.style.transform = "scale(1)";
      };
    };

    document.querySelectorAll(".expand-img-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const raw = btn.getAttribute("data-project-images");
        imagesList = raw ? raw.split(",") : [];
        currentIndex = 0;

        if (modalImg && imagesList.length > 0) {
          modalImg.src = imagesList[currentIndex];
          modalImg.style.opacity = "1";
          modalImg.style.transform = "scale(1)";
          modal.showModal();
          const multi = imagesList.length > 1;
          [nextBtn, prevBtn].forEach((el) =>
            el?.classList.toggle("hidden", !multi),
          );
        }
      });
    });

    nextBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex + 1) % imagesList.length;
      updateView();
    });

    prevBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex - 1 + imagesList.length) % imagesList.length;
      updateView();
    });

    const closeHandler = () => modal.close();
    [closeBtn, bgClose].forEach((el) =>
      el?.addEventListener("click", closeHandler),
    );
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeHandler();
    });
  };

  initModal();
  document.addEventListener("astro:after-swap", initModal);
</script>

<style>
  html:has(dialog[open]) {
    overflow: hidden;
  }

  #modal-img {
    max-width: 92vw;
    max-height: 88vh;
  }

  /* Animaci√≥n de entrada suave para el modal */
  dialog[open] {
    animation: fadeIn 0.3s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
