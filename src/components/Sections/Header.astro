---
import { Icon } from "astro-icon/components";
import SideBar from "../Headerbadge.astro";
import LanguageToggle from "../LanguageToggle.astro";
---

<!-- Language Toggle - Fixed top right for desktop -->
<div class="fixed top-5 right-4 lg:right-6 xl:right-8 z-[60] hidden lg:block">
  <LanguageToggle />
</div>

<aside
  id="main-sidebar"
  class="fixed right-2 sm:right-4 lg:right-6 xl:right-8 top-1/2 -translate-y-1/2 z-50 hidden lg:block"
  aria-label="Navegación lateral"
>
  <nav
    aria-label="Menú de escritorio"
    class="flex flex-col gap-1.5 sm:gap-2 rounded-full bg-slate-900/80 px-2.5 sm:px-3 py-3 sm:py-4 backdrop-blur-lg ring-1 ring-white/20 transition-all duration-300 ease-smooth-out hover:ring-shakespeare-500/30 hover:shadow-lg hover:shadow-shakespeare-500/10"
  >
    <SideBar
      href="#sobre-mi"
      name="Inicio"
      nameKey="nav.home"
      icon="mdi:home"
    />
    <SideBar
      href="#experiencia"
      name="Experiencia"
      nameKey="nav.experience"
      icon="mdi:briefcase"
    />
    <SideBar
      href="#proyectos"
      name="Proyectos"
      nameKey="nav.projects"
      icon="mdi:folder-multiple"
    />
    <SideBar
      href="#certifications"
      name="Certificaciones"
      nameKey="nav.certifications"
      icon="mdi:certificate-outline"
    />
    <SideBar
      href="#skills"
      name="Habilidades"
      nameKey="nav.skills"
      icon="mdi:code-braces"
    />
    <SideBar
      href="#contacto"
      name="Contacto"
      nameKey="nav.contact"
      icon="mdi:email"
    />
  </nav>
</aside>

<header
  class="fixed top-0 left-0 right-0 z-50 lg:hidden"
>
  <div class="flex items-center justify-end px-3 sm:px-4 md:px-6 py-3 sm:py-3.5 md:py-4">
    <!-- Controles derecha -->
    <div class="flex items-center gap-2 sm:gap-3">
      <LanguageToggle />
      
      <!-- Botón menú hamburguesa -->
      <button
        id="mobile-menu-toggle"
        class="p-1.5 sm:p-2 text-slate-100 hover:text-shakespeare-400 transition-colors duration-300"
        aria-label="Abrir menú"
        aria-expanded="false"
      >
        <Icon name="mdi:menu" class="w-5 h-5 sm:w-6 sm:h-6" />
      </button>
    </div>
  </div>

  <!-- Menú móvil desplegable -->
  <nav
    id="mobile-menu"
    class="hidden bg-slate-950/95 backdrop-blur-lg border-t border-white/10"
    aria-label="Navegación principal móvil"
  >
    <div class="px-3 sm:px-4 py-2 sm:py-3 space-y-0.5 sm:space-y-1">
      <a
        href="#sobre-mi"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.home"
        data-section="sobre-mi"
      >
        Inicio
      </a>
      <a
        href="#experiencia"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.experience"
        data-section="experiencia"
      >
        Experiencia
      </a>
      <a
        href="#proyectos"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.projects"
        data-section="proyectos"
      >
        Proyectos
      </a>
      <a
        href="#certifications"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.certifications"
        data-section="certifications"
      >
        Certificaciones
      </a>
      <a
        href="#skills"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.skills"
        data-section="skills"
      >
        Habilidades
      </a>
      <a
        href="#contacto"
        class="nav-link mobile-nav-item block px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-slate-100 hover:text-shakespeare-400 hover:bg-shakespeare-500/10 rounded-lg transition-all duration-300"
        data-i18n="nav.contact"
        data-section="contacto"
      >
        Contacto
      </a>
    </div>
  </nav>
</header>

<script>
  function initMobileMenu() {
    const menuToggle = document.getElementById("mobile-menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileNavItems = document.querySelectorAll(".mobile-nav-item");

    if (!menuToggle || !mobileMenu) return;

    menuToggle.addEventListener("click", () => {
      const isExpanded = menuToggle.getAttribute("aria-expanded") === "true";
      
      if (isExpanded) {
        mobileMenu.classList.add("hidden");
        menuToggle.setAttribute("aria-expanded", "false");
      } else {
        mobileMenu.classList.remove("hidden");
        menuToggle.setAttribute("aria-expanded", "true");
      }
    });

    // Cerrar menú al hacer click en un enlace
    mobileNavItems.forEach((item) => {
      item.addEventListener("click", () => {
        mobileMenu.classList.add("hidden");
        menuToggle.setAttribute("aria-expanded", "false");
      });
    });
  }

  function initActiveSection() {
    const sections = document.querySelectorAll("section[id]");
    const navLinks = document.querySelectorAll(".nav-link");

    console.log("Sections found:", sections.length);
    console.log("Nav links found:", navLinks.length);

    if (sections.length === 0 || navLinks.length === 0) {
      console.warn("No sections or nav links found");
      return;
    }

    // Configurar Intersection Observer
    const observerOptions = {
      root: null,
      rootMargin: "-10% 0px -50% 0px",
      threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const sectionId = entry.target.id;
          console.log("Section active:", sectionId);

          // Remover clase activa de todos los links
          navLinks.forEach((link) => {
            const linkSection = link.getAttribute("data-section");
            if (linkSection === sectionId) {
              link.classList.add("active");
              console.log("Added active class to:", link);
            } else {
              link.classList.remove("active");
            }
          });
        }
      });
    }, observerOptions);

    // Observar todas las secciones
    sections.forEach((section) => {
      observer.observe(section);
      console.log("Observing section:", section.id);
    });
  }

  // Inicializar funciones
  function initHeader() {
    initMobileMenu();
    initActiveSection();
  }

  // Inicializar en carga del DOM
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initHeader);
  } else {
    initHeader();
  }

  // Reinicializar en navegación de Astro (si usas view transitions)
  document.addEventListener("astro:page-load", initHeader);
</script>

<style is:global>
  /* Estilos para nav links activos - móvil */
  header .nav-link.active {
    color: #5eb3e4 !important;
    font-weight: 700 !important;
    background-color: rgba(94, 179, 228, 0.15) !important;
  }

  /* Estilos para nav links activos - desktop sidebar */
  aside .nav-link.active {
    color: #20cef0 !important;
    background-color: rgba(94, 179, 228, 0.15) !important;
    box-shadow: 0 0 0 1px rgba(94, 179, 228, 0.4) !important;
    transform: scale(1.1) !important;
  }
</style>
