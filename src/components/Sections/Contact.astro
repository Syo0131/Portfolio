---
import SectionTitle from "../SectionTitle.astro";
import { Icon } from "astro-icon/components";
---

<section
  id="contacto"
  class="py-12 sm:py-16 md:py-24 px-4 sm:px-6 lg:px-8"
  aria-labelledby="contact-title"
>
  <div class="max-w-2xl mx-auto">
    <SectionTitle class="mb-6 sm:mb-8 md:mb-10" titleKey="contact.title">
      ¿Tienes algún proyecto en mente?
    </SectionTitle>

    <div
      class="contact-card relative bg-gradient-to-br from-slate-900/80 to-slate-900/40 backdrop-blur-md border border-shakespeare-800/40 rounded-3xl p-6 sm:p-8 md:p-10 shadow-2xl overflow-hidden"
    >
      {/* Decorative elements */}
      <div
        class="absolute -top-20 -right-20 w-40 h-40 bg-shakespeare-500/10 rounded-full blur-3xl pointer-events-none"
      >
      </div>
      <div
        class="absolute -bottom-20 -left-20 w-40 h-40 bg-shakespeare-600/10 rounded-full blur-3xl pointer-events-none"
      >
      </div>

      {/* Header */}
      <div class="relative text-center mb-8">
        <div
          class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-shakespeare-500/20 border border-shakespeare-500/30 mb-4"
        >
          <Icon
            name="material-symbols:mail-rounded"
            class="w-8 h-8 text-shakespeare-400"
          />
        </div>
        <p class="text-base text-slate-300" data-i18n="contact.subtitle">
          Completa el formulario y te responderé lo antes posible.
        </p>
      </div>

      <form id="contact-form" class="relative space-y-5 sm:space-y-6">
        <div style="display: none;" aria-hidden="true">
          <input type="text" name="website" tabindex="-1" autocomplete="off" />
        </div>

        {/* Name field */}
        <div class="form-group">
          <label
            for="name"
            class="flex items-center gap-2 text-sm font-semibold text-slate-200 mb-2"
          >
            <Icon name="mdi:account" class="size-4 text-shakespeare-500" />
            <span data-i18n="contact.name">Nombre</span>
          </label>
          <div class="relative">
            <input
              type="text"
              id="name"
              name="from_name"
              required
              minlength="2"
              maxlength="100"
              class="form-input w-full px-4 py-3.5 bg-slate-950/50 border-2 border-shakespeare-800/40 rounded-xl text-white placeholder-slate-500 focus:border-shakespeare-500 focus:bg-slate-950/70 focus:shadow-lg focus:shadow-shakespeare-500/10 outline-none transition-all duration-300"
              placeholder="Tu nombre completo"
              data-i18n-placeholder="contact.namePlaceholder"
            />
            <div
              class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
            >
            </div>
          </div>
        </div>

        {/* Email field */}
        <div class="form-group">
          <label
            for="email"
            class="flex items-center gap-2 text-sm font-semibold text-slate-200 mb-2"
          >
            <Icon name="mdi:email" class="size-4 text-shakespeare-500" />
            <span data-i18n="contact.email">Email</span>
          </label>
          <div class="relative">
            <input
              type="email"
              id="email"
              name="reply_to"
              required
              class="form-input w-full px-4 py-3.5 bg-slate-950/50 border-2 border-shakespeare-800/40 rounded-xl text-white placeholder-slate-500 focus:border-shakespeare-500 focus:bg-slate-950/70 focus:shadow-lg focus:shadow-shakespeare-500/10 outline-none transition-all duration-300"
              placeholder="tu@email.com"
              data-i18n-placeholder="contact.emailPlaceholder"
            />
            <div
              class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
            >
            </div>
          </div>
        </div>

        {/* Message field */}
        <div class="form-group">
          <label
            for="message"
            class="flex items-center gap-2 text-sm font-semibold text-slate-200 mb-2"
          >
            <Icon name="mdi:message-text" class="size-4 text-shakespeare-500" />
            <span data-i18n="contact.message">Mensaje</span>
          </label>
          <div class="relative">
            <textarea
              id="message"
              name="message"
              required
              minlength="10"
              maxlength="1000"
              rows="5"
              class="form-input w-full px-4 py-3.5 bg-slate-950/50 border-2 border-shakespeare-800/40 rounded-xl text-white placeholder-slate-500 focus:border-shakespeare-500 focus:bg-slate-950/70 focus:shadow-lg focus:shadow-shakespeare-500/10 outline-none transition-all duration-300 resize-none"
              placeholder="Cuéntame sobre tu proyecto o idea..."
              data-i18n-placeholder="contact.messagePlaceholder"></textarea>
            <div
              class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
            >
            </div>
          </div>
        </div>

        {/* Submit button */}
        <button
          type="submit"
          id="submit-btn"
          aria-live="polite"
          class="group relative w-full bg-gradient-to-r from-shakespeare-600 to-shakespeare-500 text-white font-bold py-4 px-8 rounded-xl hover:from-shakespeare-500 hover:to-shakespeare-400 transition-all duration-300 flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden shadow-lg shadow-shakespeare-500/25 hover:shadow-xl hover:shadow-shakespeare-500/30 hover:-translate-y-0.5"
        >
          {/* Button shine effect */}
          <div
            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"
          >
          </div>

          <Icon
            name="material-symbols:send-rounded"
            class="w-5 h-5 sm:w-6 sm:h-6 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform duration-300"
            aria-hidden="true"
          />
          <span id="btn-text" class="relative" data-i18n="contact.send"
            >Enviar mensaje</span
          >
        </button>

        {/* Status message */}
        <div
          id="status-message"
          class="min-h-[24px] flex items-center justify-center"
          aria-live="assertive"
        >
        </div>
      </form>
    </div>
  </div>
</section>

<style>
  .contact-card {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-group {
    animation: fadeIn 0.4s ease-out forwards;
    animation-delay: calc(var(--index, 0) * 100ms);
  }

  .form-group:nth-child(2) {
    --index: 1;
  }
  .form-group:nth-child(3) {
    --index: 2;
  }
  .form-group:nth-child(4) {
    --index: 3;
  }

  .form-input:focus + .input-glow {
    opacity: 1;
    box-shadow: 0 0 20px rgba(4, 187, 227, 0.15);
  }

  /* Success state */
  .form-input.success {
    border-color: #22c55e;
  }

  /* Error state */
  .form-input.error {
    border-color: #ef4444;
  }
</style>

<script>
  import emailjs from "@emailjs/browser";

  function initContactForm() {
    // Initialize EmailJS with your public key
    const publicKey = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY;
    const serviceId = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID;
    const templateId = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID;

    if (!publicKey || !serviceId || !templateId) {
      console.error("EmailJS credentials not found in environment variables");
      return;
    }

    emailjs.init(publicKey);

    const form = document.getElementById("contact-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
      "submit-btn",
    ) as HTMLButtonElement;
    const btnText = document.getElementById("btn-text") as HTMLSpanElement;
    const statusMessage = document.getElementById(
      "status-message",
    ) as HTMLDivElement;

    if (!form || !submitBtn || !btnText || !statusMessage) return;

    // Get translations
    const getCurrentLang = () => localStorage.getItem("lang") || "es";

    const translations = {
      es: {
        sending: "Enviando...",
        success: "¡Mensaje enviado con éxito!",
        error: "Error al enviar el mensaje. Por favor, intenta de nuevo.",
        send: "Enviar mensaje",
      },
      en: {
        sending: "Sending...",
        success: "Message sent successfully!",
        error: "Error sending message. Please try again.",
        send: "Send message",
      },
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // Evita el comportamiento por defecto del formulario

      const lang = getCurrentLang() as "es" | "en";
      const t = translations[lang];

      // Disable button and show loading state
      submitBtn.disabled = true;
      btnText.textContent = t.sending;

      try {
        // Send email using EmailJS
        await emailjs.sendForm(serviceId, templateId, form);

        // Show success message
        statusMessage.innerHTML = `
          <div class="flex items-center gap-2 text-green-400 font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>${t.success}</span>
          </div>
        `;

        // Reset form
        form.reset();

        // Clear success message after 5 seconds
        setTimeout(() => {
          statusMessage.innerHTML = "";
        }, 5000);
      } catch (error) {
        console.error("Error al enviar el formulario:", error);

        // Show error message
        statusMessage.innerHTML = `
          <div class="flex items-center gap-2 text-red-400 font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>${t.error}</span>
          </div>
        `;

        // Clear error message after 5 seconds
        setTimeout(() => {
          statusMessage.innerHTML = "";
        }, 5000);
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        btnText.textContent = t.send;
      }
    });
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", initContactForm);
  document.addEventListener("astro:page-load", initContactForm);
</script>
