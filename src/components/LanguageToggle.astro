---
import { Icon } from "astro-icon/components";
import { translations } from "../i18n/translations";

// Make translations available to the client-side script
const translationsJSON = JSON.stringify(translations);
---

<button
  id="lang-toggle"
  class="group relative flex items-center gap-1.5 px-2 py-1.5 lg:px-3 lg:py-2 rounded-full bg-slate-900/60 lg:bg-slate-900/80 backdrop-blur-lg text-slate-300 hover:text-shakespeare-400 lg:hover:text-shakespeare-400 transition-all duration-300 hover:scale-105 lg:hover:scale-105 ring-1 ring-white/10 lg:ring-white/20 hover:ring-shakespeare-500/40 lg:hover:ring-shakespeare-500/40 hover:shadow-lg hover:shadow-shakespeare-500/10 lg:hover:shadow-shakespeare-500/10 active:scale-100"
  aria-label="Toggle language"
  title="Cambiar idioma / Change language"
>
  <Icon
    name="mdi:web"
    class="w-4 h-4 lg:w-4 lg:h-4 transition-transform duration-300 group-hover:rotate-12 lg:group-hover:rotate-12"
  />
  <span
    id="lang-text"
    class="text-xs font-semibold tracking-wider transition-all duration-300"
    >ES</span
  >
</button>

<script define:vars={{ translationsJSON }}>
  function initLanguageToggle() {
    const langToggles = document.querySelectorAll("#lang-toggle");
    const langTexts = document.querySelectorAll("#lang-text");

    // Parse translations from server
    const translations = JSON.parse(translationsJSON);

    // Get current language from localStorage or default to 'es'
    let currentLang = localStorage.getItem("lang") || "es";

    // Update text on load
    updateLangText(currentLang);

    // Apply translations on load
    applyTranslations(currentLang);

    langToggles.forEach((langToggle) => {
      langToggle?.addEventListener("click", () => {
        currentLang = currentLang === "es" ? "en" : "es";
        localStorage.setItem("lang", currentLang);
        updateLangText(currentLang);
        applyTranslations(currentLang);
      });
    });

    function updateLangText(lang) {
      langTexts.forEach((langText) => {
        if (langText) {
          langText.textContent = lang === "es" ? "ES" : "EN";
        }
      });
    }

    function applyTranslations(lang) {
      // Update all elements with data-i18n attribute
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (key) {
          const translation = getTranslation(lang, key);
          if (translation) {
            el.textContent = translation;
          }
        }
      });

      // Update placeholders
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (
          key &&
          (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement)
        ) {
          const translation = getTranslation(lang, key);
          if (translation) {
            el.placeholder = translation;
          }
        }
      });

      // Update aria-labels
      document.querySelectorAll("[data-i18n-aria]").forEach((el) => {
        const key = el.getAttribute("data-i18n-aria");
        if (key) {
          const translation = getTranslation(lang, key);
          if (translation) {
            el.setAttribute("aria-label", translation);
          }
        }
      });

      // Update html lang attribute
      document.documentElement.lang = lang;
    }

    function getTranslation(lang, key) {
      return translations[lang]?.[key] || null;
    }
  }

  // Initialize on DOMContentLoaded
  document.addEventListener("DOMContentLoaded", initLanguageToggle);

  // Also initialize on Astro page load (for view transitions)
  document.addEventListener("astro:page-load", initLanguageToggle);
</script>
